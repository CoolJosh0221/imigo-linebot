"""Tests for language detection service"""
import pytest
from services.language_detection import LanguageDetectionService


class TestLanguageDetectionService:
    """Test LanguageDetectionService class"""

    def test_initialization(self):
        """Test service initialization"""
        service = LanguageDetectionService(default_language="id")
        assert service.default_language == "id"

    def test_initialization_invalid_default(self):
        """Test initialization with invalid default language"""
        service = LanguageDetectionService(default_language="invalid")
        # Should fall back to 'id'
        assert service.default_language == "id"

    def test_detect_english(self):
        """Test detecting English text"""
        service = LanguageDetectionService()
        text = "Hello, how are you today?"
        lang = service.detect_language(text)
        assert lang == "en"

    def test_detect_indonesian(self):
        """Test detecting Indonesian text"""
        service = LanguageDetectionService()
        text = "Selamat pagi, apa kabar?"
        lang = service.detect_language(text)
        assert lang == "id"

    def test_detect_chinese(self):
        """Test detecting Chinese text"""
        service = LanguageDetectionService()
        text = "你好，今天天氣很好"
        lang = service.detect_language(text)
        assert lang == "zh"

    def test_detect_vietnamese(self):
        """Test detecting Vietnamese text"""
        service = LanguageDetectionService()
        text = "Xin chào, bạn khỏe không?"
        lang = service.detect_language(text)
        assert lang == "vi"

    def test_detect_empty_text(self):
        """Test detecting empty text returns default"""
        service = LanguageDetectionService(default_language="en")
        lang = service.detect_language("")
        assert lang == "en"

    def test_detect_whitespace_only(self):
        """Test detecting whitespace-only text returns default"""
        service = LanguageDetectionService(default_language="id")
        lang = service.detect_language("   \n\t  ")
        assert lang == "id"

    def test_detect_unsupported_language(self):
        """Test that unsupported languages return default"""
        service = LanguageDetectionService(default_language="id")
        # German text (not in supported languages)
        text = "Guten Tag, wie geht es dir?"
        lang = service.detect_language(text)
        # Should return default since German is not supported
        assert lang == "id"

    def test_get_language_name(self):
        """Test getting language names"""
        service = LanguageDetectionService()

        assert "English" in service.get_language_name("en")
        assert "Indonesia" in service.get_language_name("id")
        assert "Chinese" in service.get_language_name("zh")
        assert "Vietnamese" in service.get_language_name("vi")
        assert "Unknown" == service.get_language_name("invalid")

    def test_is_supported_language(self):
        """Test checking if language is supported"""
        service = LanguageDetectionService()

        assert service.is_supported_language("en") is True
        assert service.is_supported_language("id") is True
        assert service.is_supported_language("zh") is True
        assert service.is_supported_language("vi") is True
        assert service.is_supported_language("th") is True
        assert service.is_supported_language("fil") is True
        assert service.is_supported_language("invalid") is False
        assert service.is_supported_language("de") is False

    def test_detect_mixed_language_text(self):
        """Test detecting language with mixed content"""
        service = LanguageDetectionService()
        # Mostly English with some numbers and punctuation
        text = "Hello! My phone number is 123-456-7890. Call me!"
        lang = service.detect_language(text)
        assert lang == "en"

    def test_detect_short_text(self):
        """Test detecting language with very short text"""
        service = LanguageDetectionService()
        # Short English text
        text = "Hi"
        lang = service.detect_language(text)
        # Should still work, but might return default if too ambiguous
        assert lang in ["en", "id"]  # Either detected or default
