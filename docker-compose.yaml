version: '3.8'
services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard (optional, secure it in production)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ./letsencrypt:/letsencrypt
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.dashboard.rule=Host(`traefik.imigo.tw`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      # Basic auth for dashboard (optional)
      # - "traefik.http.routers.dashboard.middlewares=auth"
      # - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$..."  # Use htpasswd to generate
    restart: unless-stopped
    networks:
      - bot-network

  # FastAPI Backend Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: migrant-worker-bot
    expose:
      - "8000"
    environment:
      - LINE_CHANNEL_SECRET=${LINE_CHANNEL_SECRET}
      - LINE_CHANNEL_ACCESS_TOKEN=${LINE_CHANNEL_ACCESS_TOKEN}
      - LLM_BASE_URL=http://vllm:8001/v1
      - MODEL_NAME=${MODEL_NAME:-aisingapore/sealion7b-instruct}
      - DATABASE_URL=sqlite+aiosqlite:///data/database.db
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
      - DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE:-id}
    volumes:
      - ./data:/data
      - ./config:/app/config:ro
    labels:
      - "traefik.enable=true"
      # API routes - only api.imigo.tw
      - "traefik.http.routers.backend.rule=Host(`api.imigo.tw`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"
      # Middlewares
      - "traefik.http.routers.backend.middlewares=rateLimit,securityHeaders,compress"
    depends_on:
      - vllm
      - traefik
    restart: unless-stopped
    networks:
      - bot-network

  # vLLM Server for SEA-LION-7B
  vllm:
    image: vllm/vllm-openai:latest
    container_name: vllm
    ports:
      - "8001:8000"
    volumes:
      - ./models:/models
    command:
      - "--model"
      - "/models/sealion-model"
      - "--dtype"
      - "bfloat16"
      - "--gpu-memory-utilization"
      - "0.85"
      - "--max-model-len"
      - "16384"
      - "--trust-remote-code"
      - "--enforce-eager"
    environment:
      NVIDIA_VISIBLE_DEVICES: all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    tty: true
    ipc: host
    restart: unless-stopped
    networks:
      - bot-network

  # Dynamic DNS Updater (for dynamic IP addresses)
  ddns-updater:
    image: qmcgaw/ddns-updater:latest
    container_name: ddns-updater
    volumes:
      - ./ddns:/updater/data
    environment:
      - PERIOD=5m
      - UPDATE_COOLDOWN_PERIOD=5m
      - PUBLICIP_FETCHERS=all
      - PUBLICIP_HTTP_PROVIDERS=all
      - PUBLICIPV4_HTTP_PROVIDERS=all
      - PUBLICIPV6_HTTP_PROVIDERS=all
      - HTTP_TIMEOUT=10s
      # Web UI
      - LISTENING_PORT=8000
      - ROOT_URL=/
      # Health check
      - HEALTH_SERVER_ADDRESS=127.0.0.1:9999
    ports:
      - "8888:8000"  # Web UI for DDNS status
    restart: unless-stopped
    networks:
      - bot-network

networks:
  bot-network:
    driver: bridge